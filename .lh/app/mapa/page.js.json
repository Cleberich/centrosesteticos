{
    "sourceFile": "app/mapa/page.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1765954777117,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1765954805308,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -70,9 +70,9 @@\n     if (modo === \"explorar\" || !userLocation) {\n       return propiedades;\n     }\n     // Si el modo es \"cerca\", filtramos las que están a menos de 10km (puedes ajustar este número)\n-    const RADIO_KM = 10;\n+    const RADIO_KM = 1;\n     return propiedades.filter((p) => {\n       if (!p.lat || !p.lng) return false;\n       const d = calcularDistancia(\n         userLocation.lat,\n"
                },
                {
                    "date": 1765954880125,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -212,9 +212,9 @@\n                 </h2>\n                 <p className=\"text-[9px] font-bold text-gray-400 uppercase tracking-widest\">\n                   {modo === \"explorar\"\n                     ? \"Mostrando todo el catálogo\"\n-                    : \"Radio de búsqueda: 10km\"}\n+                    : \"Radio de búsqueda: 1km\"}\n                 </p>\n               </div>\n               <div className=\"flex items-center gap-2\">\n                 <span\n"
                }
            ],
            "date": 1765954777117,
            "name": "Commit-0",
            "content": "\"use client\";\n\nimport dynamic from \"next/dynamic\";\nimport { useEffect, useState, useMemo } from \"react\";\nimport { collection, getDocs } from \"firebase/firestore\";\nimport { db, auth } from \"@/services/firebase\";\nimport { useAuthState } from \"react-firebase-hooks/auth\";\nimport AuthGuard from \"@/components/AuthGuard\";\nimport Link from \"next/link\";\n\n// Componente de Mapa cargado dinámicamente para evitar errores de SSR con Leaflet/Google Maps\nconst MapComponent = dynamic(() => import(\"@/components/MapComponent\"), {\n  ssr: false,\n  loading: () => (\n    <div className=\"h-full w-full bg-gray-50 flex items-center justify-center text-gray-400 font-medium\">\n      Cargando mapa...\n    </div>\n  ),\n});\n\n/**\n * Función Haversine para calcular distancia entre dos puntos geográficos en KM\n */\nconst calcularDistancia = (lat1, lon1, lat2, lon2) => {\n  const R = 6371; // Radio de la Tierra en km\n  const dLat = (lat2 - lat1) * (Math.PI / 180);\n  const dLon = (lon2 - lon1) * (Math.PI / 180);\n  const a =\n    Math.sin(dLat / 2) * Math.sin(dLat / 2) +\n    Math.cos(lat1 * (Math.PI / 180)) *\n      Math.cos(lat2 * (Math.PI / 180)) *\n      Math.sin(dLon / 2) *\n      Math.sin(dLon / 2);\n  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n  return R * c;\n};\n\nexport default function MapaPage() {\n  const [user] = useAuthState(auth);\n  const [propiedades, setPropiedades] = useState([]);\n  const [loading, setLoading] = useState(true);\n  const [isLocating, setIsLocating] = useState(false);\n  const [mapCenter, setMapCenter] = useState(null);\n  const [userLocation, setUserLocation] = useState(null);\n  const [modo, setModo] = useState(\"explorar\"); // \"explorar\" o \"cerca\"\n  const [showLocationGuide, setShowLocationGuide] = useState(false);\n\n  // 1. Cargar datos de Firebase\n  useEffect(() => {\n    const fetchPropiedades = async () => {\n      try {\n        const snapshot = await getDocs(collection(db, \"propiedades\"));\n        const data = snapshot.docs.map((doc) => ({\n          id: doc.id,\n          ...doc.data(),\n        }));\n        setPropiedades(data);\n      } catch (err) {\n        console.error(\"Error Firestore:\", err);\n      } finally {\n        setLoading(false);\n      }\n    };\n    fetchPropiedades();\n  }, []);\n\n  // 2. Lógica de Filtrado Dinámico\n  // Se recalculan las propiedades a mostrar cada vez que cambia el modo o la ubicación del usuario\n  const propiedadesAMostrar = useMemo(() => {\n    if (modo === \"explorar\" || !userLocation) {\n      return propiedades;\n    }\n    // Si el modo es \"cerca\", filtramos las que están a menos de 10km (puedes ajustar este número)\n    const RADIO_KM = 10;\n    return propiedades.filter((p) => {\n      if (!p.lat || !p.lng) return false;\n      const d = calcularDistancia(userLocation.lat, userLocation.lng, p.lat, p.lng);\n      return d <= RADIO_KM;\n    });\n  }, [propiedades, modo, userLocation]);\n\n  // 3. Función para obtener ubicación real\n  const handleObtenerUbicacion = () => {\n    if (!navigator.geolocation) {\n      alert(\"Tu navegador no soporta geolocalización.\");\n      return;\n    }\n\n    setIsLocating(true);\n\n    navigator.geolocation.getCurrentPosition(\n      (pos) => {\n        const coords = {\n          lat: pos.coords.latitude,\n          lng: pos.coords.longitude,\n        };\n        setUserLocation(coords);\n        setMapCenter({\n          ...coords,\n          zoom: 15,\n          timestamp: Date.now(),\n        });\n        setModo(\"cerca\"); // Activa automáticamente el modo \"cerca\"\n        setIsLocating(false);\n        setShowLocationGuide(false);\n      },\n      (err) => {\n        setIsLocating(false);\n        if (err.code === 1) {\n          setShowLocationGuide(true);\n        } else {\n          alert(\"Error al obtener ubicación. Intenta de nuevo.\");\n        }\n      },\n      { enableHighAccuracy: true, timeout: 15000 }\n    );\n  };\n\n  return (\n    <AuthGuard>\n      <div className=\"flex flex-col h-screen bg-white overflow-hidden text-black antialiased\">\n        {/* HEADER */}\n        <header className=\"h-16 border-b border-gray-100 flex items-center justify-between px-6 z-20 bg-white shrink-0\">\n          <div className=\"flex items-center gap-2\">\n            <div className=\"w-8 h-8 bg-black rounded flex items-center justify-center shadow-lg\">\n              <div className=\"w-3 h-3 bg-white rotate-45\"></div>\n            </div>\n            <span className=\"text-xl font-bold tracking-tighter italic\">\n              CERCANÍAS\n            </span>\n          </div>\n\n          {/* SELECTOR DE MODO (EXPLORAR VS CERCA) */}\n          <div className=\"flex bg-gray-100 p-1 rounded-full border border-gray-200\">\n            <button\n              onClick={() => setModo(\"explorar\")}\n              className={`px-4 py-1.5 rounded-full text-[10px] font-black uppercase tracking-widest transition-all ${\n                modo === \"explorar\" ? \"bg-white shadow-sm text-black\" : \"text-gray-400\"\n              }`}\n            >\n              Explorar\n            </button>\n            <button\n              onClick={handleObtenerUbicacion}\n              className={`px-4 py-1.5 rounded-full text-[10px] font-black uppercase tracking-widest transition-all ${\n                modo === \"cerca\" ? \"bg-white shadow-sm text-blue-600\" : \"text-gray-400\"\n              }`}\n            >\n              Cerca de mí\n            </button>\n          </div>\n\n          <Link\n            href=\"/dashboard\"\n            className=\"hidden md:block bg-black text-white px-5 py-2 rounded-full text-xs font-black uppercase tracking-widest transition-transform active:scale-95\"\n          >\n            + Publicar\n          </Link>\n        </header>\n\n        <div className=\"flex-1 flex flex-col md:flex-row relative overflow-hidden\">\n          {/* ÁREA DE MAPA */}\n          <main className=\"absolute inset-0 md:relative md:flex-1 z-0\">\n            {/* Pasamos solo las propiedades filtradas al mapa */}\n            <MapComponent\n              propiedades={propiedadesAMostrar}\n              centerOverride={mapCenter}\n            />\n\n            {/* BOTÓN FLOTANTE DE UBICACIÓN (Para refrescar o centrar) */}\n            <button\n              onClick={handleObtenerUbicacion}\n              disabled={isLocating}\n              className=\"absolute right-4 bottom-[42vh] md:bottom-8 z-30 bg-white p-4 rounded-full shadow-2xl border border-gray-100 active:scale-90 transition-all flex items-center justify-center disabled:opacity-70\"\n            >\n              {isLocating ? (\n                <div className=\"w-6 h-6 border-2 border-blue-600 border-t-transparent rounded-full animate-spin\" />\n              ) : (\n                <div className=\"flex items-center gap-2 text-blue-600 font-bold\">\n                  <svg\n                    width=\"22\"\n                    height=\"22\"\n                    viewBox=\"0 0 24 24\"\n                    fill=\"none\"\n                    stroke=\"currentColor\"\n                    strokeWidth=\"2.5\"\n                  >\n                    <polygon points=\"3 11 22 2 13 21 11 13 3 11\" />\n                  </svg>\n                </div>\n              )}\n            </button>\n          </main>\n\n          {/* ÁREA DE LISTADO */}\n          <aside className=\"z-10 w-full md:w-[420px] lg:w-[480px] bg-white border-t md:border-t-0 md:border-l border-gray-100 absolute bottom-0 md:relative h-[40vh] md:h-full flex flex-col shadow-[0_-10px_40px_rgba(0,0,0,0.08)]\">\n            <div className=\"w-12 h-1 bg-gray-200 rounded-full mx-auto my-3 md:hidden\"></div>\n            \n            <div className=\"px-6 py-4 flex justify-between items-center bg-white border-b border-gray-50\">\n              <div>\n                <h2 className=\"text-xl font-black italic tracking-tighter uppercase\">\n                  {modo === \"explorar\" ? \"Propiedades\" : \"Cerca de ti\"}\n                </h2>\n                <p className=\"text-[9px] font-bold text-gray-400 uppercase tracking-widest\">\n                  {modo === \"explorar\" ? \"Mostrando todo el catálogo\" : \"Radio de búsqueda: 10km\"}\n                </p>\n              </div>\n              <div className=\"flex items-center gap-2\">\n                <span className={`w-2 h-2 rounded-full animate-pulse ${modo === 'cerca' ? 'bg-blue-500' : 'bg-green-500'}`}></span>\n                <span className=\"text-[10px] font-bold text-gray-400 uppercase tracking-widest\">\n                  {propiedadesAMostrar.length} Resultados\n                </span>\n              </div>\n            </div>\n\n            <div className=\"flex-1 overflow-y-auto p-5 space-y-6 pb-24 scrollbar-hide\">\n              {loading ? (\n                <div className=\"text-center py-10 text-gray-300 font-medium animate-pulse\">\n                  Sincronizando...\n                </div>\n              ) : propiedadesAMostrar.length === 0 ? (\n                <div className=\"text-center py-12\">\n                  <p className=\"text-gray-400 font-bold italic\">No hay propiedades en esta zona.</p>\n                  <button \n                    onClick={() => setModo(\"explorar\")}\n                    className=\"mt-4 text-xs font-black uppercase tracking-tighter border-b-2 border-black\"\n                  >\n                    Ver todas las propiedades\n                  </button>\n                </div>\n              ) : (\n                propiedadesAMostrar.map((p) => (\n                  <div\n                    key={p.id}\n                    className=\"flex gap-4 group cursor-pointer active:opacity-60 transition-all\"\n                    onClick={() =>\n                      setMapCenter({ lat: p.lat, lng: p.lng, zoom: 17, timestamp: Date.now() })\n                    }\n                  >\n                    <div className=\"w-24 h-24 md:w-32 md:h-32 rounded-3xl overflow-hidden bg-gray-50 shrink-0 border border-gray-100\">\n                      <img\n                        src={p.fotos?.[0] || \"/placeholder.jpg\"}\n                        className=\"w-full h-full object-cover group-hover:scale-105 transition-transform\"\n                        alt=\"\"\n                      />\n                    </div>\n                    <div className=\"flex flex-col justify-between py-1 flex-1\">\n                      <div>\n                        <h3 className=\"font-bold text-[15px] leading-tight line-clamp-2\">\n                          {p.titulo}\n                        </h3>\n                        <p className=\"text-gray-400 text-[10px] mt-1 uppercase font-bold tracking-wider\">\n                          {p.barrio || \"Uruguay\"}\n                        </p>\n                      </div>\n                      <p className=\"text-lg font-black tracking-tighter\">\n                        USD {p.precio?.toLocaleString()}\n                      </p>\n                    </div>\n                  </div>\n                ))\n              )}\n            </div>\n          </aside>\n        </div>\n\n        {/* MODAL EDUCATIVO SAFARI IPHONE */}\n        {showLocationGuide && (\n          <div className=\"fixed inset-0 z-[100] bg-black/70 backdrop-blur-md flex items-end md:items-center justify-center p-4\">\n            <div className=\"bg-white w-full max-w-sm rounded-[40px] p-8 shadow-2xl\">\n              <div className=\"flex justify-center mb-6 text-blue-600 bg-blue-50 w-20 h-20 rounded-full mx-auto items-center\">\n                <svg width=\"36\" height=\"36\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\">\n                  <path d=\"M12 22s-8-4.5-8-11.8A8 8 0 0112 2a8 8 0 018 7.2c0 7.3-8 11.8-8 11.8z\" />\n                  <circle cx=\"12\" cy=\"9\" r=\"3\" />\n                </svg>\n              </div>\n              <h2 className=\"text-2xl font-black text-center mb-2 tracking-tighter italic uppercase leading-none\">\n                Ubicación desactivada\n              </h2>\n              <p className=\"text-gray-500 text-center text-sm mb-8 font-medium\">\n                Para ver lo que hay cerca, activa el permiso en Safari:\n              </p>\n\n              <div className=\"space-y-4 mb-8 text-gray-700\">\n                <div className=\"flex items-center gap-4\">\n                  <span className=\"w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center shrink-0 font-black\">1</span>\n                  <p className=\"text-sm font-bold\">Toca el icono <span className=\"text-blue-600\">AA</span> o el candado en la barra.</p>\n                </div>\n                <div className=\"flex items-center gap-4\">\n                  <span className=\"w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center shrink-0 font-black\">2</span>\n                  <p className=\"text-sm font-bold\">Entra a Configuración del sitio web.</p>\n                </div>\n                <div className=\"flex items-center gap-4\">\n                  <span className=\"w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center shrink-0 font-black\">3</span>\n                  <p className=\"text-sm font-bold uppercase\">Ubicación → <span className=\"text-green-600\">Permitir</span></p>\n                </div>\n              </div>\n\n              <button\n                onClick={() => window.location.reload()}\n                className=\"w-full bg-blue-600 text-white py-4 rounded-2xl font-black uppercase tracking-widest text-xs shadow-xl active:scale-95 transition-all\"\n              >\n                Ya lo hice, recargar\n              </button>\n              <button\n                onClick={() => setShowLocationGuide(false)}\n                className=\"w-full text-gray-400 py-3 mt-2 font-bold text-[10px] uppercase\"\n              >\n                Cerrar\n              </button>\n            </div>\n          </div>\n        )}\n      </div>\n    </AuthGuard>\n  );\n}"
        }
    ]
}